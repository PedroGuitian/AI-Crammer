{% extends 'cram_app/layout.html' %}

{% block title %}New Cram Hub{% endblock %}

{% block content %}
  <h2>Create a New Cram Hub</h2>

  {% if error %}
    <p style="color: red;">{{ error }}</p>
  {% endif %}

  <form method="post" enctype="multipart/form-data" id="uploadForm">
    {% csrf_token %}

    <label for="files">Upload Notes or Study Files:</label><br>
    <div id="dropzone" class="dropzone">
      <p>Drag and drop files here or click to upload +</p>
      <input type="file" id="files" name="files" multiple required style="display:none;">
    </div><br>

    <input type="hidden" id="hubTitle" name="title">
    <button type="button" onclick="openModal()">Upload & Create Hub</button>
  </form>

  <div id="titleModal" class="modal-overlay" style="display:none;">
    <div class="modal">
      <h3>Name Your Cram Hub</h3>
      <input type="text" id="modalInput" placeholder="Enter hub title..." style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc;"><br><br>
      <button onclick="submitWithTitle()">Submit</button>
      <button onclick="closeModal()" style="margin-left: 10px;">Cancel</button>
    </div>
  </div>

  <script>
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("files");

    dropzone.addEventListener("click", () => fileInput.click());

    dropzone.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.classList.add("highlight");
    });

    dropzone.addEventListener("dragleave", () => {
      dropzone.classList.remove("highlight");
    });

    dropzone.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("highlight");
      fileInput.files = e.dataTransfer.files;
    });

    function openModal() {
      document.getElementById("titleModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("titleModal").style.display = "none";
    }

    function submitWithTitle() {
      const title = document.getElementById("modalInput").value;
      if (title.trim() !== '') {
        document.getElementById("hubTitle").value = title;
        document.getElementById("uploadForm").submit();
      } else {
        alert("Please enter a title.");
      }
    }
  </script>

  <style>
    .dropzone {
      border: 2px dashed #007bff;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      background-color: #f9f9f9;
      transition: background-color 0.3s ease;
    }
    .dropzone.highlight {
      background-color: #e6f2ff;
    }
  </style>

  {% if hub_created %}
    <div style="margin-top: 20px;">
      <h3>Next Steps:</h3>
      <a href="{% url 'generate_cram_sheet' hub_id=hub.id %}" class="button">Generate Cram Sheet</a>
      <a href="{% url 'generate_test_questions' hub_id=hub.id %}" class="button">Generate Test Questions</a>
    </div>
  {% endif %}
{% endblock %}
